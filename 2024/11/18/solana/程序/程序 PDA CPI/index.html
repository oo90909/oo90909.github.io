<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="程序程序是无状态的但程序可以创建账户当作程序状态程序可升级（默认，可手动设置为不可升级） PDA：拿来干嘛？ &#x3D;&#x3D;使用程序id（程序的地址,不是存储代码的地址），增量种子（随机数），可选种子（string） 生成的地址，没有私钥&#x3D;&#x3D; 但是可以使用上面的程序id为其签名 生成过程： 在solana playGround 调用含有PDA的函数：此时必须写测试 1">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://oo90909.github.io/2024/11/18/solana/%E7%A8%8B%E5%BA%8F/%E7%A8%8B%E5%BA%8F%20PDA%20CPI/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="程序程序是无状态的但程序可以创建账户当作程序状态程序可升级（默认，可手动设置为不可升级） PDA：拿来干嘛？ &#x3D;&#x3D;使用程序id（程序的地址,不是存储代码的地址），增量种子（随机数），可选种子（string） 生成的地址，没有私钥&#x3D;&#x3D; 但是可以使用上面的程序id为其签名 生成过程： 在solana playGround 调用含有PDA的函数：此时必须写测试 1">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://oo90909.github.io/2024/11/18/solana/%E7%A8%8B%E5%BA%8F/%E7%A8%8B%E5%BA%8F%20PDA%20CPI/image.png">
<meta property="article:published_time" content="2024-11-18T09:36:45.563Z">
<meta property="article:modified_time" content="2025-03-21T10:58:16.947Z">
<meta property="article:author" content="fathergun">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://oo90909.github.io/2024/11/18/solana/%E7%A8%8B%E5%BA%8F/%E7%A8%8B%E5%BA%8F%20PDA%20CPI/image.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://oo90909.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-solana/程序/程序 PDA CPI" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/11/18/solana/%E7%A8%8B%E5%BA%8F/%E7%A8%8B%E5%BA%8F%20PDA%20CPI/" class="article-date">
  <time class="dt-published" datetime="2024-11-18T09:36:45.563Z" itemprop="datePublished">2024-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><strong>程序</strong><br>程序是无状态的<br>但程序可以创建账户当作程序状态<br>程序可升级（默认，可手动设置为不可升级）</p>
<p><strong>PDA：</strong><br>拿来干嘛？</p>
<p>&#x3D;&#x3D;使用程序id（程序的地址,不是存储代码的地址），增量种子（随机数），可选种子（string） 生成的地址，没有私钥&#x3D;&#x3D;</p>
<p>但是可以使用上面的程序id为其签名</p>
<p>生成过程：<br><img src="/2024/11/18/solana/%E7%A8%8B%E5%BA%8F/%E7%A8%8B%E5%BA%8F%20PDA%20CPI/image.png" alt="Alt text"></p>
<p>在solana playGround 调用含有PDA的函数：此时必须写测试</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Client code...</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> anchor <span class="keyword">from</span> <span class="string">&quot;@coral-xyz/anchor&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PublicKey</span>, <span class="title class_">Keypair</span>, <span class="title class_">SystemProgram</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@solana/web3.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 配置 Solana Provider</span></span><br><span class="line"><span class="keyword">const</span> provider = anchor.<span class="property">AnchorProvider</span>.<span class="title function_">env</span>();</span><br><span class="line">anchor.<span class="title function_">setProvider</span>(provider);</span><br><span class="line"><span class="keyword">const</span> program = anchor.<span class="property">workspace</span>.<span class="property">TokenExample</span> <span class="keyword">as</span> anchor.<span class="property">Program</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 定义 signer (用户的钱包)</span></span><br><span class="line"><span class="keyword">const</span> signer = provider.<span class="property">wallet</span> <span class="keyword">as</span> anchor.<span class="property">Wallet</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 计算 mint PDA</span></span><br><span class="line"><span class="keyword">const</span> [mintPDA, mintBump] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">  [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;mint&quot;</span>)],</span><br><span class="line">  program.<span class="property">programId</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 计算 token account PDA</span></span><br><span class="line"><span class="keyword">const</span> [tokenAccountPDA, tokenBump] =</span><br><span class="line">  anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;token&quot;</span>)],</span><br><span class="line">    program.<span class="property">programId</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 发送 `create_and_mint_tokens` 交易</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createAndMintTokens</span>(<span class="params">amount: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Mint PDA:&quot;</span>, mintPDA.<span class="title function_">toBase58</span>());</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Token Account PDA:&quot;</span>, tokenAccountPDA.<span class="title function_">toBase58</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> tx = <span class="keyword">await</span> program.<span class="property">methods</span></span><br><span class="line">    .<span class="title function_">createAndMintTokens</span>(<span class="keyword">new</span> anchor.<span class="title function_">BN</span>(amount))</span><br><span class="line">    .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">      <span class="attr">signer</span>: signer.<span class="property">publicKey</span>,</span><br><span class="line">      <span class="attr">mint</span>: mintPDA,</span><br><span class="line">      <span class="attr">tokenAccount</span>: tokenAccountPDA,</span><br><span class="line">      <span class="attr">tokenProgram</span>: anchor.<span class="property">utils</span>.<span class="property">token</span>.<span class="property">TOKEN_PROGRAM_ID</span>,</span><br><span class="line">      <span class="attr">systemProgram</span>: <span class="title class_">SystemProgram</span>.<span class="property">programId</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">signers</span>([]) <span class="comment">// 由于使用 PDA 作为 mint，signer 为空</span></span><br><span class="line">    .<span class="title function_">rpc</span>();</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;✅ Transaction Signature:&quot;</span>, tx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 运行函数</span></span><br><span class="line"><span class="title function_">createAndMintTokens</span>(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 计算 PDA (mint)</span></span><br><span class="line"><span class="keyword">const</span> [mintPDA1, mintBump1] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">  [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;mint&quot;</span>)],</span><br><span class="line">  program.<span class="property">programId</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 计算 PDA (sender_token_account)</span></span><br><span class="line"><span class="keyword">const</span> [senderTokenAccountPDA, senderBump] =</span><br><span class="line">  anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;token&quot;</span>)],</span><br><span class="line">    program.<span class="property">programId</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 计算 recipient 的 ATA (Associated Token Account)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAssociatedTokenAccount</span>(<span class="params">owner: PublicKey, mint: PublicKey</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> anchor.<span class="property">utils</span>.<span class="property">token</span>.<span class="title function_">associatedAddress</span>(&#123;</span><br><span class="line">    mint,</span><br><span class="line">    owner,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">transferTokens</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> recipientTokenAccount = <span class="keyword">await</span> <span class="title function_">getAssociatedTokenAccount</span>(</span><br><span class="line">    signer.<span class="property">publicKey</span>,</span><br><span class="line">    mintPDA1</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Mint PDA:&quot;</span>, mintPDA1.<span class="title function_">toBase58</span>());</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Sender Token Account PDA:&quot;</span>, senderTokenAccountPDA.<span class="title function_">toBase58</span>());</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Recipient Token Account:&quot;</span>, recipientTokenAccount.<span class="title function_">toBase58</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> tx = <span class="keyword">await</span> program.<span class="property">methods</span></span><br><span class="line">    .<span class="title function_">transferTokens</span>()</span><br><span class="line">    .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">      <span class="attr">signer</span>: signer.<span class="property">publicKey</span>,</span><br><span class="line">      <span class="attr">mint</span>: mintPDA1,</span><br><span class="line">      <span class="attr">senderTokenAccount</span>: senderTokenAccountPDA,</span><br><span class="line">      recipientTokenAccount,</span><br><span class="line">      <span class="attr">tokenProgram</span>: anchor.<span class="property">utils</span>.<span class="property">token</span>.<span class="property">TOKEN_PROGRAM_ID</span>,</span><br><span class="line">      <span class="attr">associatedTokenProgram</span>: anchor.<span class="property">utils</span>.<span class="property">token</span>.<span class="property">ASSOCIATED_PROGRAM_ID</span>,</span><br><span class="line">      <span class="attr">systemProgram</span>: <span class="title class_">SystemProgram</span>.<span class="property">programId</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">signers</span>([])</span><br><span class="line">    .<span class="title function_">rpc</span>();</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;✅ Transaction Signature:&quot;</span>, tx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 执行转账</span></span><br><span class="line"><span class="title function_">transferTokens</span>();</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对应的rust代码</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::&#123;</span><br><span class="line">    associated_token::AssociatedToken,</span><br><span class="line">    token_interface::&#123;<span class="keyword">self</span>, Mint, MintTo, TokenAccount, TokenInterface, TransferChecked&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">declare_id!(<span class="string">&quot;3jN3YkbbJXFy1KBebxgKYraPU3XY9KZ6W9PrcGEj5oxN&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#[program]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> token_example &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">create_and_mint_tokens</span>(ctx: Context&lt;CreateAndMintTokens&gt;, amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        msg!(<span class="string">&quot;Mint PDA bump: &#123;&#125;&quot;</span>, ctx.bumps.mint);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">signer_seeds</span>: &amp;[&amp;[&amp;[<span class="type">u8</span>]]] = &amp;[&amp;[<span class="string">b&quot;mint&quot;</span>, &amp;[ctx.bumps.mint]]];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">cpi_accounts</span> = MintTo &#123;</span><br><span class="line">            mint: ctx.accounts.mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            to: ctx.accounts.token_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            authority: ctx.accounts.mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">cpi_program</span> = ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">cpi_context</span> = CpiContext::<span class="title function_ invoke__">new</span>(cpi_program, cpi_accounts).<span class="title function_ invoke__">with_signer</span>(signer_seeds);</span><br><span class="line">        token_interface::<span class="title function_ invoke__">mint_to</span>(cpi_context, amount)?;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">transfer_tokens</span>(ctx: Context&lt;TransferTokens&gt;) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">signer_seeds</span>: &amp;[&amp;[&amp;[<span class="type">u8</span>]]] = &amp;[&amp;[<span class="string">b&quot;token&quot;</span>, &amp;[ctx.bumps.sender_token_account]]];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">amount</span> = ctx.accounts.sender_token_account.amount;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">decimals</span> = ctx.accounts.mint.decimals;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">cpi_accounts</span> = TransferChecked &#123;</span><br><span class="line">            mint: ctx.accounts.mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            from: ctx.accounts.sender_token_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            to: ctx.accounts.recipient_token_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            authority: ctx.accounts.sender_token_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">cpi_program</span> = ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">cpi_context</span> = CpiContext::<span class="title function_ invoke__">new</span>(cpi_program, cpi_accounts).<span class="title function_ invoke__">with_signer</span>(signer_seeds);</span><br><span class="line">        token_interface::<span class="title function_ invoke__">transfer_checked</span>(cpi_context, amount, decimals)?;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Accounts)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">CreateAndMintTokens</span>&lt;<span class="symbol">&#x27;info</span>&gt; &#123;</span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> signer: Signer&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init,</span></span><br><span class="line"><span class="meta">        payer = signer,</span></span><br><span class="line"><span class="meta">        mint::decimals = 6,</span></span><br><span class="line"><span class="meta">        mint::authority = mint,</span></span><br><span class="line"><span class="meta">        mint::freeze_authority = mint,</span></span><br><span class="line"><span class="meta">        seeds = [b<span class="string">&quot;mint&quot;</span>]</span>,</span><br><span class="line">        bump</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> mint: InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;,</span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init,</span></span><br><span class="line"><span class="meta">        payer = signer,</span></span><br><span class="line"><span class="meta">        token::mint = mint,</span></span><br><span class="line"><span class="meta">        token::authority = token_account,</span></span><br><span class="line"><span class="meta">        seeds = [b<span class="string">&quot;token&quot;</span>]</span>,</span><br><span class="line">        bump</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> token_account: InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;,</span><br><span class="line">    <span class="keyword">pub</span> token_program: Interface&lt;<span class="symbol">&#x27;info</span>, TokenInterface&gt;,</span><br><span class="line">    <span class="keyword">pub</span> system_program: Program&lt;<span class="symbol">&#x27;info</span>, System&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Accounts)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">TransferTokens</span>&lt;<span class="symbol">&#x27;info</span>&gt; &#123;</span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> signer: Signer&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        seeds = [b<span class="string">&quot;mint&quot;</span>]</span>,</span><br><span class="line">        bump</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> mint: InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;,</span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        token::mint = mint,</span></span><br><span class="line"><span class="meta">        token::authority = sender_token_account,</span></span><br><span class="line"><span class="meta">        seeds = [b<span class="string">&quot;token&quot;</span>]</span>,</span><br><span class="line">        bump</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> sender_token_account: InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;,</span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init_if_needed,</span></span><br><span class="line"><span class="meta">        payer = signer,</span></span><br><span class="line"><span class="meta">        associated_token::mint = mint,</span></span><br><span class="line"><span class="meta">        associated_token::authority = signer,</span></span><br><span class="line"><span class="meta">        associated_token::token_program = token_program,</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> recipient_token_account: InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;,</span><br><span class="line">    <span class="keyword">pub</span> token_program: Interface&lt;<span class="symbol">&#x27;info</span>, TokenInterface&gt;,</span><br><span class="line">    <span class="keyword">pub</span> associated_token_program: Program&lt;<span class="symbol">&#x27;info</span>, AssociatedToken&gt;,</span><br><span class="line">    <span class="keyword">pub</span> system_program: Program&lt;<span class="symbol">&#x27;info</span>, System&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行以上程序涉及的公钥和地址：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Instruction <span class="number">0</span></span><br><span class="line">   Program:   <span class="number">3</span>MQtMR35i7AqJ2bsvF46FxuPYaN7a1an1wy21aiisrjV (<span class="number">3</span>)程序的公钥</span><br><span class="line">   Account <span class="number">0</span>: <span class="title function_ invoke__">GKLMW9vLjNBHBdjgvWnozd82LHQMps5QoPUK6dT1spnD</span> (<span class="number">1</span>)这是什么地址</span><br><span class="line">   Account <span class="number">1</span>: <span class="number">748</span>YuxhvX7M9Gt7JP6T6swQHGFB295haksmJhagrBaB9 (<span class="number">0</span>)fee payer</span><br><span class="line">   Account <span class="number">2</span>: <span class="number">11111111111111111111111111111111</span> (<span class="number">2</span>)系统所有钱包的owner</span><br><span class="line">   Data: [<span class="number">175</span>, <span class="number">175</span>, <span class="number">109</span>, <span class="number">31</span>, <span class="number">13</span>, <span class="number">152</span>, <span class="number">155</span>, <span class="number">237</span>, <span class="number">42</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"> Status: <span class="literal">Ok</span></span><br><span class="line">   Fee: ◎<span class="number">0.00001</span></span><br><span class="line">   Account <span class="number">0</span> balance: ◎<span class="number">2.29078316</span> <span class="punctuation">-&gt;</span> ◎<span class="number">2.28977092</span></span><br><span class="line">   Account <span class="number">1</span> balance: ◎<span class="number">0</span> <span class="punctuation">-&gt;</span> ◎<span class="number">0.00100224</span></span><br><span class="line">   Account <span class="number">2</span> balance: ◎<span class="number">0.000000001</span></span><br><span class="line">   Account <span class="number">3</span> balance: ◎<span class="number">0.00139896</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><strong>CPI</strong></p>
<p>在A调用B时，A的签名会沿用到B</p>
<p><strong>程序结构</strong></p>
<p>anchor keys sync：<br>在使用克隆库时可以考虑，将declare_id!(“11111111111111111111111111111111”);<br>的公钥更新为&#x2F;target&#x2F;deploy&#x2F;your_program_name.json的值</p>
<p>#[program] macro </p>
<p>指令 指令处理程序(struct Context<T> )</T></p>
<p>Context 结构如下</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Context</span>&lt;<span class="symbol">&#x27;a</span>, <span class="symbol">&#x27;b</span>, <span class="symbol">&#x27;c</span>, <span class="symbol">&#x27;info</span>, T&gt; &#123;  </span><br><span class="line">    <span class="comment">/// 当前执行的程序ID。  </span></span><br><span class="line">    <span class="keyword">pub</span> program_id: &amp;<span class="symbol">&#x27;a</span> Pubkey,  </span><br><span class="line">    <span class="comment">/// 程序执行涉及到的账户</span></span><br><span class="line">    <span class="keyword">pub</span> accounts: &amp;<span class="symbol">&#x27;b</span> <span class="keyword">mut</span> T,  </span><br><span class="line">    <span class="comment">///  未涉及到的账户</span></span><br><span class="line">    <span class="comment">/// 使用此项时要非常小心。  </span></span><br><span class="line">    <span class="keyword">pub</span> remaining_accounts: &amp;<span class="symbol">&#x27;c</span> [AccountInfo&lt;<span class="symbol">&#x27;info</span>&gt;],  </span><br><span class="line">    <span class="comment">///PDA的增量种子</span></span><br><span class="line">    <span class="keyword">pub</span> bumps: BTreeMap&lt;<span class="type">String</span>, <span class="type">u8</span>&gt;,  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">#[account(init, payer = signer, space = 8 + 8)]</span></span><br><span class="line">用于验证下面的账户地址是否满足括号中的条件</span><br><span class="line"> <span class="meta">#[account(mut)]</span></span><br><span class="line"> 用于验证下面的账户是否是括号中的类型</span><br><span class="line"></span><br><span class="line"> 当账户被验证以后，就可以通过ctx.accounts访问（Context结构体）</span><br><span class="line"></span><br><span class="line">  <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        seeds = [b<span class="string">&quot;message&quot;</span>, user.key().as_ref()]</span>,</span><br><span class="line">        bump = message_account.bump,</span><br><span class="line">        realloc = <span class="number">8</span> + <span class="number">32</span> + <span class="number">4</span> + message.<span class="title function_ invoke__">len</span>() + <span class="number">1</span>,</span><br><span class="line">        realloc::payer = user,<span class="comment">//明确谁为内存扩展付费</span></span><br><span class="line">        realloc::zero = <span class="literal">true</span>,<span class="comment">//清理原有内存</span></span><br><span class="line">    )]</span><br><span class="line">        <span class="keyword">pub</span> message_account: Account&lt;<span class="symbol">&#x27;info</span>, MessageAccount&gt;,</span><br><span class="line"> </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>account宏</strong><br>分配程序所有者：将之前的declare_id的账户地址规定为账户所有者<br>账户区分符，用于之后序列化和反序列化时判断<br>序列化和反序列化：账户数据和账户类型的变化</p>
<p><strong>excuteable类型统计</strong></p>
<p>minttoken：false-store state<br>wallet：false<br>Token Extensions program：true<br>11111111..111111：true<br>Program Executable Data Account：false</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://oo90909.github.io/2024/11/18/solana/%E7%A8%8B%E5%BA%8F/%E7%A8%8B%E5%BA%8F%20PDA%20CPI/" data-id="cm8ofd1bc002ed0udajgx3wbd" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/11/21/solana/token/token/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2024/11/18/solana/%E4%BA%A4%E6%98%93%E8%B4%B9%EF%BC%8Cgas/%E4%BA%A4%E6%98%93%E8%B4%B9/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/uniswap2/" rel="tag">uniswap2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uniswap3/" rel="tag">uniswap3</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/uniswap2/" style="font-size: 20px;">uniswap2</a> <a href="/tags/uniswap3/" style="font-size: 10px;">uniswap3</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/03/">March 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/02/">February 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/01/">January 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/12/">December 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">November 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">October 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/03/24/%E6%AF%95%E8%AE%BE/%E8%AF%AD%E6%B3%95mapping/%E7%BF%BB%E8%AF%91%E8%A6%81%E7%82%B9/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/03/23/%E6%AF%95%E8%AE%BE/%E8%AF%AD%E6%B3%95mapping/solidity2/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/03/20/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%89%E5%85%A8/%E5%8D%8F%E8%AE%AE%E4%B8%8E%E6%A0%87%E5%87%86%E5%BA%93/ERC1155/ERC1155/">EIP712</a>
          </li>
        
          <li>
            <a href="/2025/03/19/solana/%E5%90%84%E7%A7%8D%E7%A8%8B%E5%BA%8F%E8%B4%A6%E6%88%B7%E7%B1%BB%E5%9E%8B/%E5%8E%9F%E7%94%9F%E7%A8%8B%E5%BA%8F/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/03/17/solana/%E5%90%84%E7%A7%8D%E7%A8%8B%E5%BA%8F%E8%B4%A6%E6%88%B7%E7%B1%BB%E5%9E%8B/%E7%A8%8B%E5%BA%8F%E8%B4%A6%E6%88%B7%E7%B1%BB%E5%9E%8B/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 fathergun<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>